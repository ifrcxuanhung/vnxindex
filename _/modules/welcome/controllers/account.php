<?php

/* * *******************************************************************************************************************
 * Client  Name ：  IFRC
 * ---------------------------------------------------------------------------------------------------------------------
 * Project Name ：  VNFDB
 * ---------------------------------------------------------------------------------------------------------------------
 * File Name    ：  account.php 
 * ---------------------------------------------------------------------------------------------------------------------
 * Entry Server ：
 * ---------------------------------------------------------------------------------------------------------------------
 * Called By    ：  System
 * ---------------------------------------------------------------------------------------------------------------------
 * Notice       ：
 * ---------------------------------------------------------------------------------------------------------------------
 * Copyright    ：  IFRC
 * ---------------------------------------------------------------------------------------------------------------------
 * Comment      ：
 * ---------------------------------------------------------------------------------------------------------------------
 * History      ：
 * ---------------------------------------------------------------------------------------------------------------------
 * Version V001 ：  2013.07.8 (LongNguyen)        New Create 
 * ******************************************************************************************************************* */

class Account extends Welcome {
    /*     * ***********************************************************************************************************
     * Name         ： __construct
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function __construct() {
        parent::__construct();
        $this->load->model('vfdb_user_model', 'muser');
    }

    /*     * ***********************************************************************************************************
     * Name         ： register
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function register() {
        
        if ($this->input->post()) {
            $email = $this->input->post('email');
            $username = $email;
            $password = $this->input->post('password');

            $additional_data = array(
                'first_name' => $this->input->post('first_name'),
                'last_name' => $this->input->post('last_name'),
                'gender' => $this->input->post('gender')
            );
            $group = array(17); // 17 is register
            $captcha = $this->session->userdata('captcha');
            if ($this->input->post('security_code') == $captcha) {
                if ($this->vfdb_ion_auth->register($username, $password, $email, $additional_data, $group)) {
                    // redirect(base_url());
                    $this->session->unset_userdata('captcha');
                    //echo "<script>self.parent.location=self.parent.location;</script>";
                    
                    $link = base_url();
                    echo "<p class='msg_reg_success' style='color:white; text-align:center; font-size:18px'>";
                    trans('register_success_please_active_email');
                    echo "<p>";
                    echo "<script>setTimeout(function(){top.location.href = '$link'},1000);</script>";
                    exit;
                }
            }
            $this->data->input = $this->input->post();
            exit;
        }
        $this->load->view('register', $this->data);
    }

    /*     * ***********************************************************************************************************
     * Name         ： check_valid_user
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function check_valid_user() {
        if ($this->input->is_ajax_request()) {
            $id = $this->input->post('id');
            $email = $this->input->post('email');
            if ($this->muser->check_user_exist($id, $email)) {
                $output = 0;
            } else {
                $output = 1;
            }
            $this->output->set_output($output);
        }
    }

    /*     * ***********************************************************************************************************
     * Name         ： reset_password
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function reset_password($code) {
        $this->load->model('auth/vfdb_ion_auth_model', 'mauth');
        if ($profile = $this->vfdb_ion_auth->forgotten_password_check($code)) {
            if (!$this->vfdb_ion_auth->forgotten_password_complete($code)) {
                $error = $this->mauth->errors();
            } else {
                echo "Reset password successful. Click <a href='" . base_url() . "'>here</a> to back home";
            }
        } else {
            show_error("Unable reset password");
        }
    }

    /*     * ***********************************************************************************************************
     * Name         ： activate
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function activate($id, $code) {
        if ($this->vfdb_ion_auth->activate($id, $code)) {
            echo "Account activation successful. Please check mail to get new password. Click <a href=" . base_url() . ">here</a> to back home";
        } else {
            show_error($this->vfdb_ion_auth->errors());
        }
    }

    /*     * ***********************************************************************************************************
     * Name         ： testmail
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function testmail() {
        $config = Array(
            'protocol' => 'smtp',
            // 'smtp_host' => 'ssl://smtp.googlemail.com',
            // 'smtp_port' => 465,
            'smtp_port' => 587,
            'smtp_host' => 'auth.smtp.1and1.fr',
            //'smtp_user' => 'service@ifrc.fr',
			'smtp_user' => 'ifrcnews@ifrc.fr',
            //'smtp_pass' => 'ifrcvn2013',
			'smtp_pass' => 'welcome',
            'mailtype' => 'html',
            'charset' => 'iso-8859-1',
                // 'newline' => '\r\n',
                // 'crlf' => '\r\n',
        );
        $this->email->initialize($config);
        $this->email->set_newline("\r\n");
        $this->email->from('ifrcnews@ifrc.fr', 'Phương');
        $this->email->to('ngthhoaiphuong@gmail.com');
        $this->email->subject('Activation Code');
        $this->email->message('lfdasjfaskfj123');
        if (!$this->email->send()) {
            show_error($this->email->print_debugger());
        } else {
            echo('DONE');
        }
        // redirect('http://google.com.vn');
        // echo "<script>self.parent.location='http://google.com.vn';</script>";
    }

    /*     * ***********************************************************************************************************
     * Name         ： test
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function test() {
        echo 234;
        echo '<iframe src="http://localhost/vfdb/account/testmail" ></iframe>';
    }

    /*     * ***********************************************************************************************************
     * Name         ： forgotten_password
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function forgotten_password() {
        $this->load->library('form_validation');
        $this->form_validation->set_rules('identity', 'Email Address', 'required');
        $captcha = $this->session->userdata('captcha');
        if ($this->form_validation->run()) {
            if ($this->input->post('security_code') == $captcha) {
                //run the forgotten password method to email an activation code to the user
                $forgotten = $this->vfdb_ion_auth->forgotten_password($this->input->post('identity'));

                if ($forgotten) { //if there were no errors
                    $this->session->unset_userdata('captcha');
                    $this->session->set_flashdata('message', $this->vfdb_ion_auth->messages());
                    $this->output->set_output($this->vfdb_ion_auth->messages());
                    // redirect(current_url(), 'refresh'); //we should display a confirmation page here instead of the login page
                } else {
                    // $this->session->set_flashdata('message', $this->ion_auth->errors());
                    // redirect("auth/forgot_password", 'refresh');
                    $this->output->set_output($this->vfdb_ion_auth->errors());
                    // show_error("Reset password failed!");
                }
            } else {
                $this->output->set_output("Invalid Captcha");
            }
        } else {
            $this->output->set_output(validation_errors());
        }
    }

    /*     * ***********************************************************************************************************
     * Name         ： update
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function update() {
        $account = $this->vfdb_ion_auth->user()->row();
        $module = $this->session->userdata('module_login');
        // if (!empty($account) && $module == 'vfdb') {
        if (!empty($account)) {
            if ($this->input->post()) {
                $this->load->model('auth/vfdb_ion_auth_model', 'mauth');
                $birthday = $this->input->post('year') . '-' . $this->input->post('month') . '-' . $this->input->post('day');
                
                if ($birthday == '0-0-0') {
                    $birthday = '';
                }
                /*
                else {
                    $birthday = strtotime($birthday);
                }
                */
                //echo $birthday;exit;
                $update_data = array(
                    'email' => $this->input->post('email'),
                    'username' => $this->input->post('email'),
                    'first_name' => $this->input->post('first_name'),
                    'last_name' => $this->input->post('last_name'),
                    'phone' => $this->input->post('phone'),
                    'address' => $this->input->post('address'),
                    'company' => $this->input->post('company'),
                    'gender' => $this->input->post('gender'),
                    'website' => $this->input->post('website'),
                    'date_birth' => $birthday
                );
                // $this->db->where('id', $account->user_id);
                if ($this->mauth->update($account->user_id, $update_data, 2)) {
                    // redirect(current_url());
                    echo "<script>self.parent.location=self.parent.location;</script>";
                }
                $this->data->error = $this->mauth->errors();
            }


            $this->data->input = (array) $account;
            $this->load->view('user_update', $this->data);
        } else {
            show_error('Access Denied! Please login before you change anything!');
        }
        // pre($account);
    }

    /*     * ***********************************************************************************************************
     * Name         ： change_password
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ：
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.08.14 (LongNguyen)  
     * *************************************************************************************************************** */

    public function change_password() {
        $account = $this->vfdb_ion_auth->user()->row();
        $module = $this->session->userdata('module_login');
        // if (!empty($account) && $module == 'vfdb') {
        if (!empty($account)) {
            if ($this->input->post()) {
                $error = '';
                $change = TRUE;
                $this->load->model('auth/vfdb_ion_auth_model', 'mauth');
                if ($this->input->post('password') != '') {
                    $change = $this->mauth->change_password($account->email, $this->input->post('old-password'), $this->input->post('password'));
                    if (!$change) {
                        $error = $this->mauth->errors();
                    } else {
                        echo "<script>self.parent.location=self.parent.location;</script>";
                    }
                }
                $this->data->error = $error;
            }
            $this->data->input = (array) $account;
            $this->load->view('change_password', $this->data);
        } else {
            show_error('Access Denied! Please login before you change anything!');
        }
        // pre($account);
    }

}