<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

/* * *******************************************************************************************************************
 * Client  Name ：  IFRC
 * ---------------------------------------------------------------------------------------------------------------------
 * Project Name ：  IMS v3.0
 * ---------------------------------------------------------------------------------------------------------------------
 * Program Name ：  testing.php
 * ---------------------------------------------------------------------------------------------------------------------
 * Entry Server ：
 * ---------------------------------------------------------------------------------------------------------------------
 * Called By    ：  System
 * ---------------------------------------------------------------------------------------------------------------------
 * Notice       ：
 * ---------------------------------------------------------------------------------------------------------------------
 * Copyright    ：  IFRC
 * ---------------------------------------------------------------------------------------------------------------------
 * Comment      ：
 * ---------------------------------------------------------------------------------------------------------------------
 * History      ：
 * ---------------------------------------------------------------------------------------------------------------------
 * Version V001 ：  2012.09.20 (LongNguyen)        New Create
 * ******************************************************************************************************************* */

class Testing extends Admin {

    protected $data;
    private $cal_dates;

    function __construct() {
        parent::__construct();
        $this->load->model('Testing_model', 'testing_model');
    }

    /*     * ***********************************************************************************************************
     * Name         ： index
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ： copy file test to root folder upload_data_indexes
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.09.12 (LongNguyen)
     * *************************************************************************************************************** */

    function index() {
        $result = array();
        $result['result'] = 'false';
        if ($this->input->is_ajax_request()) {
            $folder = $this->input->post('folder');
            if ($folder != '') {
                $folder = str_pad($folder, 3, "0", STR_PAD_LEFT);
                full_copy('./assets/data_upload_indexes/testing/backup', './assets/data_upload_indexes');
                if (is_dir('./assets/data_upload_indexes/testing/calculation/' . $folder) == TRUE) {
                    full_copy('./assets/data_upload_indexes/testing/calculation/' . $folder, './assets/data_upload_indexes/');
                    $result['result'] = 'ok';
                }
                $result['folder'] = $folder;
            }
        }
        $this->output->set_output(json_encode($result));
    }

    /*     * ***********************************************************************************************************
     * Name         ： report
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ： tạo report cho phần testing auto
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：$_POST folder
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：json
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.10.02 (LongNguyen)
     * *************************************************************************************************************** */

    function report() {
        if ($this->input->is_ajax_request()) {
            $this->load->Model('sysformat_model', 'msys');
            $folder = $this->input->post('folder');
            $result = array();
            if ($folder != '') {
                $folder = str_pad($folder, 3, "0", STR_PAD_LEFT);
                $dir = './assets/data_upload_indexes/testing/calculation/' . $folder . '/idx_specs.txt';
                if (is_file($dir) == TRUE) {
                    $data_export = $this->msys->listView('idx_specs');
                    file_put_contents('./assets/data_upload_indexes/testing/calculation/result/' . $folder . '-idx_specs-' . date("Y-m-d-H-i-s") . '.txt', $data_export);
                    $input = array();
                    $input['file'] = 'idx_specs.txt';
                    $input['table'] = 'idx_specs_check';
                    $input['empty'] = 'true';
                    $input['folder'] = 'data_upload_indexes/testing/calculation/' . $folder;
                    Modules::run('admin/import/insert', $input);
                    $result = $this->testing_model->compareIdx_specsIdx_specs_check($folder);
                }
            }
            $this->output->set_output(json_encode($result));
        }
    }

    /*     * ***********************************************************************************************************
     * Name         ： checkin
     * -----------------------------------------------------------------------------------------------------------------
     * Description  ： copy file test to root folder upload_data_indexes
     * -----------------------------------------------------------------------------------------------------------------
     * Params       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Return       ：
     * -----------------------------------------------------------------------------------------------------------------
     * Warning      ：
     * -----------------------------------------------------------------------------------------------------------------
     * Copyright    ： IFRC
     * -----------------------------------------------------------------------------------------------------------------
     * M001         ： New  2012.10.3 (LongNguyen)
     * *************************************************************************************************************** */

    function checkin() {
        $result = array();
        $result['result'] = 'false';
        if ($this->input->is_ajax_request()) {
            $folder = $this->input->post('folder');
            if ($folder != '') {
                $folder = str_pad($folder, 3, "0", STR_PAD_LEFT);
                full_copy('./assets/data_upload_indexes/testing/backup', './assets/data_upload_indexes');
                if (is_dir('./assets/data_upload_indexes/testing/checkin/' . $folder) == TRUE) {
                    full_copy('./assets/data_upload_indexes/testing/checkin/' . $folder, './assets/data_upload_indexes/');
                    $result['result'] = 'ok';
                }
                $result['folder'] = $folder;
            }
        }
        $this->output->set_output(json_encode($result));
    }

}